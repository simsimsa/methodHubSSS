CREATE TABLE IF NOT EXISTS "user" (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    is_banned BOOLEAN DEFAULT FALSE
);

CREATE TABLE IF NOT EXISTS theme (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    description TEXT
);

CREATE TABLE IF NOT EXISTS category (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) UNIQUE NOT NULL,
    description TEXT,
    theme INTEGER NOT NULL REFERENCES theme(id) ON DELETE RESTRICT
);

CREATE TABLE IF NOT EXISTS material (
    id SERIAL PRIMARY KEY,
    title VARCHAR(500) NOT NULL,
    description TEXT,
    text TEXT,
    author VARCHAR(255) NOT NULL,
    category INTEGER NOT NULL REFERENCES category(id) ON DELETE RESTRICT,
    theme INTEGER NOT NULL REFERENCES theme(id) ON DELETE RESTRICT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS favorit (
    material_id INTEGER NOT NULL REFERENCES material(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES "user"(id) ON DELETE CASCADE,
    PRIMARY KEY (material_id, user_id)
);

-- Инициализация данных

INSERT INTO theme (id, name, description) VALUES 
    (1, 'Программирование', 'Методические материалы по программированию и разработке программного обеспечения'),
    (2, 'Дизайн', 'Методические материалы по дизайну, графике и визуальному оформлению'),
    (3, 'Математика', 'Методические материалы по математике, алгебре, геометрии и математическому анализу'),
    (4, 'Языки', 'Методические материалы по изучению языков и лингвистике'),
    (5, 'Наука', 'Методические материалы по естественным наукам: физике, химии, биологии')
ON CONFLICT (id) DO NOTHING;

INSERT INTO category (id, name, description, theme) VALUES 
    (1, 'Python', 'Программирование на языке Python', 1),
    (2, 'JavaScript', 'Разработка на JavaScript и веб-технологиях', 1),
    (3, 'Java', 'Программирование на Java', 1),
    (4, 'C++', 'Программирование на C++', 1),
    (5, 'Графический дизайн', 'Создание графических материалов и иллюстраций', 2),
    (6, 'Веб-дизайн', 'Дизайн веб-сайтов и интерфейсов', 2),
    (7, 'UI/UX дизайн', 'Дизайн пользовательских интерфейсов и опыта взаимодействия', 2),
    (8, 'Алгебра', 'Алгебраические методы и уравнения', 3),
    (9, 'Геометрия', 'Геометрические фигуры, пространство и измерения', 3),
    (10, 'Математический анализ', 'Дифференциальное и интегральное исчисление', 3),
    (11, 'Английский язык', 'Изучение английского языка', 4),
    (12, 'Русский язык', 'Изучение русского языка и литературы', 4),
    (13, 'Физика', 'Физические законы и явления', 5),
    (14, 'Химия', 'Химические процессы и вещества', 5),
    (15, 'Биология', 'Живые организмы и биологические процессы', 5)
ON CONFLICT (id) DO NOTHING;

INSERT INTO "user" (id, name, password_hash, email, is_admin, is_banned) VALUES
    (1, 'Администратор', '$2b$10$GAa5lRxlldl0bfQEbdLhvenGwu9SNllc5Fxn16kPL4/F0EzjgiSAO', 'admin@methodhub.ru', TRUE, FALSE),
    (2, 'Иванова Мария Петровна', '$2b$10$GAa5lRxlldl0bfQEbdLhvenGwu9SNllc5Fxn16kPL4/F0EzjgiSAO', 'teacher1@example.com', FALSE, FALSE),
    (3, 'Петров Иван Сергеевич', '$2b$10$GAa5lRxlldl0bfQEbdLhvenGwu9SNllc5Fxn16kPL4/F0EzjgiSAO', 'teacher2@example.com', FALSE, FALSE)
ON CONFLICT (id) DO NOTHING;

INSERT INTO material (id, title, description, text, author, category, theme) VALUES
    (1, 'Введение в Python: основы синтаксиса', 'Базовый курс по программированию на Python для начинающих', '# Основы синтаксиса Python

Python — это высокоуровневый язык программирования с простым и читаемым синтаксисом. В этом уроке мы изучим **основные конструкции языка**: переменные, типы данных (строки, числа, списки), условные операторы (`if`, `elif`, `else`) и циклы (`for`, `while`). 

Каждая конструкция будет рассмотрена на практических примерах с подробными комментариями. В конце урока вы сможете написать простые программы для решения базовых задач.', 'Иванова М.П.', 1, 1),
    (2, 'Работа с функциями и модулями в Python', 'Углубленное изучение функций и модульной структуры кода', '# Функции и модули в Python

**Функции** позволяют структурировать код и избегать повторений. Мы научимся создавать функции с параметрами по умолчанию, использовать `*args` и `**kwargs` для работы с переменным количеством аргументов, а также разберем понятие области видимости переменных (локальные и глобальные).

Модули — это способ организации кода в отдельные файлы. Изучим импорт стандартных модулей (`math`, `datetime`, `random`) и создание собственных модулей для переиспользования кода в разных проектах.', 'Петров И.С.', 1, 1),
    (3, 'ООП в Python: классы и объекты', 'Объектно-ориентированное программирование на Python', '# Объектно-ориентированное программирование

**ООП** — это парадигма программирования, основанная на концепции объектов. В Python классы определяются с помощью ключевого слова `class`. Мы изучим четыре основных принципа ООП: **инкапсуляцию** (сокрытие данных), **наследование** (создание новых классов на основе существующих), **полиморфизм** (разное поведение объектов одного типа) и **абстракцию**.

На практических примерах создадим классы с методами, конструкторами и свойствами, а также рассмотрим наследование и переопределение методов.', 'Иванова М.П.', 1, 1),
    (4, 'JavaScript: основы языка и DOM', 'Введение в JavaScript и работу с DOM-элементами', '# JavaScript и DOM

JavaScript — это язык программирования, который делает веб-страницы интерактивными. Изучим **основы синтаксиса**: переменные (`let`, `const`, `var`), типы данных, функции (обычные и стрелочные), массивы и объекты.

**DOM (Document Object Model)** — это представление HTML-документа в виде дерева объектов. Научимся находить элементы на странице (`getElementById`, `querySelector`), изменять их содержимое и стили, а также обрабатывать события (клики, наведение мыши, ввод текста) для создания интерактивных интерфейсов.', 'Сидоров А.В.', 2, 1),
    (5, 'Асинхронное программирование в JavaScript', 'Promises, async/await и работа с асинхронным кодом', '# Асинхронность в JavaScript

JavaScript выполняется в однопоточном окружении, поэтому для работы с долгими операциями (запросы к серверу, чтение файлов) используется **асинхронное программирование**. Изучим **Promises** — объекты, представляющие результат асинхронной операции, и методы `.then()`, `.catch()`, `.finally()`.

Современный синтаксис **async/await** делает асинхронный код более читаемым и похожим на синхронный. Разберем обработку ошибок с помощью `try/catch` и параллельное выполнение нескольких асинхронных операций с помощью `Promise.all()`.', 'Петров И.С.', 2, 1),
    (6, 'Основы Java: синтаксис и структура программы', 'Базовый курс программирования на Java', '# Введение в Java

Java — это строго типизированный объектно-ориентированный язык. Изучим **базовый синтаксис**: примитивные типы данных (`int`, `double`, `boolean`, `char`), операторы, управляющие конструкции (`if-else`, `switch`, циклы `for`, `while`).

**Структура Java-программы** основана на классах. Каждая программа должна содержать метод `main()`, который является точкой входа. Разберем процесс компиляции (`.java` → `.class`) и выполнения программы через JVM (Java Virtual Machine).', 'Козлова Е.Н.', 3, 1),
    (7, 'Графический дизайн: основы композиции', 'Принципы построения визуальной композиции', '# Основы композиции в дизайне

**Композиция** — это расположение элементов на плоскости для создания гармоничного визуального образа. Изучим основные принципы: **баланс** (симметричный и асимметричный), **контраст** (различие размеров, цветов, форм), **ритм** (повторение элементов) и **иерархию** (выделение главного).

Работа с **цветом** включает понимание цветового круга, теплых и холодных оттенков, а также психологии цвета. **Типографика** — искусство работы со шрифтами: выбор гарнитуры, размеров, межстрочных интервалов для обеспечения читаемости и выразительности текста.', 'Волкова О.И.', 5, 2),
    (8, 'Работа в Adobe Photoshop: базовые инструменты', 'Практический курс по работе в Photoshop', '# Базовые инструменты Photoshop

**Интерфейс программы** состоит из панели инструментов, палитры слоев, панели свойств и рабочего пространства. Основные инструменты: **кисть** (Brush) для рисования, **лассо** (Lasso) для выделения, **штамп** (Clone Stamp) для копирования областей, **градиент** (Gradient) для плавных переходов.

**Слои** — основа работы в Photoshop. Каждый элемент можно разместить на отдельном слое, что позволяет редактировать его независимо. **Маски** позволяют скрывать части слоя без удаления пикселей. Коррекция цвета выполняется через корректирующие слои (Levels, Curves, Hue/Saturation), а ретушь — инструментами Healing Brush и Spot Healing Brush.', 'Волкова О.И.', 5, 2),
    (9, 'Веб-дизайн: адаптивная верстка', 'Создание адаптивных веб-интерфейсов', '# Адаптивная верстка

**Адаптивный дизайн** обеспечивает корректное отображение сайта на всех устройствах. **Медиа-запросы** (`@media`) позволяют применять разные стили в зависимости от размера экрана. Используются breakpoints (точки перелома): мобильные (до 768px), планшеты (768-1024px), десктопы (1024px+).

**Flexbox** — одномерная система раскладки для создания гибких контейнеров. **CSS Grid** — двумерная система для сложных макетов. Комбинируя эти технологии, можно создавать адаптивные сетки, которые автоматически перестраиваются под размер экрана. Тестирование на реальных устройствах и эмуляторах обязательно.', 'Смирнов Д.А.', 6, 2),
    (10, 'UI/UX дизайн: проектирование интерфейсов', 'Методика проектирования пользовательских интерфейсов', '# Проектирование интерфейсов

**User Research** — исследование пользователей через интервью, опросы и наблюдение. На основе данных создаются **персоны** (user personas) — вымышленные персонажи, представляющие целевую аудиторию. **User Journey** — карта пути пользователя, показывающая все точки взаимодействия с продуктом.

**Wireframes** — схематичные чертежи интерфейса без деталей дизайна, показывающие структуру и расположение элементов. **Прототипирование** — создание интерактивных макетов для тестирования навигации и функциональности. **Usability testing** помогает выявить проблемы до запуска продукта.', 'Смирнов Д.А.', 7, 2),
    (11, 'Алгебра: решение квадратных уравнений', 'Методика решения квадратных уравнений различными способами', '# Квадратные уравнения

**Квадратное уравнение** имеет вид `ax² + bx + c = 0`, где `a ≠ 0`. Уравнения бывают **полные** (все коэффициенты ненулевые) и **неполные** (один или два коэффициента равны нулю). Для неполных уравнений решение упрощается: выносим общий множитель или используем извлечение корня.

Для полных уравнений применяем **формулу дискриминанта**: `D = b² - 4ac`. Если `D > 0`, уравнение имеет два корня; если `D = 0`, один корень; если `D < 0`, корней нет. **Теорема Виета** связывает корни с коэффициентами: `x₁ + x₂ = -b/a` и `x₁ · x₂ = c/a`, что удобно для проверки решения.', 'Иванова М.П.', 8, 3),
    (12, 'Системы линейных уравнений', 'Решение систем линейных уравнений', '# Системы линейных уравнений

**Система линейных уравнений** — это несколько уравнений с несколькими переменными. Основные методы решения: **метод подстановки** (выражаем одну переменную и подставляем в другое уравнение), **метод сложения** (складываем или вычитаем уравнения для исключения переменной), **графический метод** (находим точку пересечения прямых).

**Матричный метод** использует матрицы и определители. Система записывается в виде `AX = B`, где `A` — матрица коэффициентов. Решение находится через обратную матрицу: `X = A⁻¹B`. Метод Крамера применяется для систем с квадратной матрицей через вычисление определителей.', 'Петров И.С.', 8, 3),
    (13, 'Геометрия: свойства треугольников', 'Изучение свойств и признаков треугольников', '# Свойства треугольников

Треугольники классифицируются по сторонам (**равносторонний**, **равнобедренный**, **разносторонний**) и углам (**остроугольный**, **прямоугольный**, **тупоугольный**). **Признаки равенства треугольников**: по двум сторонам и углу между ними, по стороне и двум прилежащим углам, по трем сторонам.

**Подобие треугольников** определяется признаками: по двум углам, по двум сторонам и углу между ними, по трем сторонам. **Медианы** (отрезки от вершин к серединам противоположных сторон), **биссектрисы** (делят углы пополам) и **высоты** (перпендикуляры к сторонам) пересекаются в одной точке и имеют особые свойства.', 'Козлова Е.Н.', 9, 3),
    (14, 'Площади и объемы геометрических фигур', 'Формулы для вычисления площадей и объемов', '# Площади и объемы

**Площади плоских фигур**: треугольник — `S = ½ah` (половина произведения основания на высоту), прямоугольник — `S = ab`, круг — `S = πr²`. Для параллелограмма и трапеции также есть специальные формулы.

**Объемы тел**: призма — `V = Sh` (площадь основания × высота), пирамида — `V = ⅓Sh`, цилиндр — `V = πr²h`, конус — `V = ⅓πr²h`, шар — `V = ⁴/₃πr³`. Важно понимать, что объем конуса и пирамиды составляет треть от объема цилиндра и призмы с теми же основанием и высотой.', 'Иванова М.П.', 9, 3),
    (15, 'Производная функции: основные правила', 'Дифференцирование функций и применение производной', '# Производная функции

**Производная** функции в точке показывает скорость изменения функции. Геометрически — это тангенс угла наклона касательной к графику. Определение через предел: `f''(x) = lim(h→0) [f(x+h) - f(x)]/h`.

**Правила дифференцирования**: производная суммы равна сумме производных, производная произведения — `(uv)'' = u''v + uv''`, производная частного — `(u/v)'' = (u''v - uv'')/v²`, производная сложной функции — `(f(g(x)))'' = f''(g(x)) · g''(x)`. Производные элементарных функций: `(xⁿ)'' = nxⁿ⁻¹`, `(sin x)'' = cos x`, `(eˣ)'' = eˣ`.', 'Петров И.С.', 10, 3),
    (16, 'Интегральное исчисление', 'Неопределенный и определенный интеграл', '# Интегральное исчисление

**Первообразная** функции `f(x)` — это функция `F(x)`, производная которой равна `f(x)`. **Неопределенный интеграл** — это множество всех первообразных: `∫f(x)dx = F(x) + C`, где `C` — постоянная интегрирования.

**Методы интегрирования**: непосредственное интегрирование (табличные интегралы), замена переменной, интегрирование по частям. **Определенный интеграл** вычисляется по формуле Ньютона-Лейбница: `∫[a to b] f(x)dx = F(b) - F(a)`. Интеграл имеет геометрический смысл — площадь криволинейной трапеции под графиком функции.', 'Козлова Е.Н.', 10, 3),
    (17, 'Английский язык: времена глаголов', 'Система времен в английском языке', '# Времена в английском языке

Английская система времен включает три основных времени: **Present** (настоящее), **Past** (прошедшее), **Future** (будущее). Каждое время имеет четыре формы: **Simple** (простое действие), **Continuous** (длительное действие), **Perfect** (завершенное действие), **Perfect Continuous** (длительное действие с результатом).

**Present Simple** используется для регулярных действий и фактов: "I work every day." **Present Continuous** — для действий, происходящих сейчас: "I am working now." **Present Perfect** — для действий с результатом в настоящем: "I have worked here for 5 years." Правильный выбор времени зависит от контекста и цели высказывания.', 'Сидорова Л.М.', 11, 4),
    (18, 'Русский язык: орфография и пунктуация', 'Правила правописания в русском языке', '# Орфография и пунктуация

**Орфография** — правила написания слов. Изучим правописание приставок (приставки на `з-с` зависят от звонкости следующего согласного), суффиксов (разные суффиксы для разных частей речи) и окончаний (склонение по падежам и спряжение глаголов).

**Пунктуация** — правила расстановки знаков препинания. В простом предложении запятые ставятся при однородных членах, обращениях, вводных словах. В сложном предложении запятая разделяет части, точка с запятой — при отсутствии союза между частями, двоеточие — при пояснении, тире — при противопоставлении или пропуске слова.', 'Волкова О.И.', 12, 4),
    (19, 'Физика: законы механики', 'Основные законы классической механики', '# Законы механики

**Первый закон Ньютона** (закон инерции): тело сохраняет состояние покоя или равномерного прямолинейного движения, если на него не действуют силы. **Второй закон**: `F = ma` — ускорение прямо пропорционально силе и обратно пропорционально массе. **Третий закон**: действие равно противодействию — силы возникают парами.

**Закон сохранения энергии**: в замкнутой системе механическая энергия сохраняется (сумма кинетической и потенциальной энергии постоянна). **Закон сохранения импульса**: сумма импульсов тел в замкнутой системе постоянна. Эти законы применяются при решении задач о столкновениях, движении под действием сил и механических системах.', 'Смирнов Д.А.', 13, 5),
    (20, 'Химия: строение атома', 'Электронное строение атомов и периодический закон', '# Строение атома

**Атом** состоит из ядра (протоны и нейтроны) и электронной оболочки (электроны). Электроны располагаются на **энергетических уровнях** (оболочках), которые делятся на подуровни (`s`, `p`, `d`, `f`). Заполнение подуровней происходит по принципу наименьшей энергии и правилу Хунда.

**Периодический закон** Менделеева: свойства элементов периодически зависят от заряда ядра. В периодической системе элементы расположены по возрастанию атомного номера. **Химическая связь** бывает ионной (перенос электронов), ковалентной (общая пара электронов) и металлической (обобществленные электроны в кристаллической решетке).', 'Петрова А.С.', 14, 5),
    (21, 'Биология: клеточное строение', 'Строение и функции клетки', '# Клеточное строение

**Клетка** — основная единица жизни. **Органоиды** — специализированные структуры, выполняющие определенные функции: **ядро** (хранение ДНК), **митохондрии** (синтез АТФ, энергетический обмен), **рибосомы** (синтез белков), **эндоплазматическая сеть** (транспорт веществ), **аппарат Гольджи** (модификация и упаковка белков), **лизосомы** (переваривание).

**Деление клетки**: **митоз** — деление соматических клеток (образуются две идентичные дочерние клетки), **мейоз** — деление половых клеток (образуются четыре клетки с половинным набором хромосом). Растительная клетка отличается от животной наличием клеточной стенки, пластид (хлоропластов) и крупной центральной вакуоли.', 'Козлова Е.Н.', 15, 5)
ON CONFLICT (id) DO NOTHING;

INSERT INTO favorit (material_id, user_id) VALUES
    (1, 2),
    (4, 2),
    (7, 2),
    (11, 2),
    (1, 3),
    (3, 3),
    (9, 3),
    (19, 3)
ON CONFLICT (material_id, user_id) DO NOTHING;

-- Обновление последовательностей
SELECT setval(pg_get_serial_sequence('user', 'id'), (SELECT MAX(id) FROM "user"));
SELECT setval(pg_get_serial_sequence('theme', 'id'), (SELECT MAX(id) FROM theme));
SELECT setval(pg_get_serial_sequence('category', 'id'), (SELECT MAX(id) FROM category));
SELECT setval(pg_get_serial_sequence('material', 'id'), (SELECT MAX(id) FROM material));
